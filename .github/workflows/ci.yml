name: ğŸŒŠ FlexAligner CI

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        # å¼ºåˆ¶å®‰è£…å…¼å®¹ç‰ˆæœ¬ï¼Œè§£å†³ transformers å†²çª
        pip install "huggingface-hub<1.0"
        pip install .[test]
        # è¡¥å…¨ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®å’ŒéŸ³é¢‘å¤„ç†æ‰€éœ€çš„åº“
        pip install numpy scipy soundfile hf_transfer

    - name: Generate Mock Assets for CI
      run: |
        # åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„ç›®å½•ç»“æ„ï¼Œè§£å†³æµ‹è¯•æ–­è¨€æŠ¥é”™
        mkdir -p assets/examples
        # ç”Ÿæˆ 1 ç§’çš„é™éŸ³æ¨¡æ‹ŸéŸ³é¢‘ (16kHz, Mono)
        python -c "import numpy as np; from scipy.io import wavfile; data=np.zeros(16000, dtype=np.int16); wavfile.write('assets/examples/SP01_001.wav', 16000, data)"
        # ç”Ÿæˆå¯¹åº”çš„è½¬å†™æ–‡æœ¬
        echo "æµ‹è¯•éŸ³é¢‘å†…å®¹" > assets/examples/SP01_001.txt
        echo "âœ… Mock assets generated successfully."

    - name: Run Pytest
      env:
        # æ ¸å¿ƒï¼šä» GitHub Secrets ä¸­å®‰å…¨æ³¨å…¥ä½ çš„ HF ä»¤ç‰Œ
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        # GitHub Actions è¿è¡Œç¯å¢ƒç›´è¿åŸç«™é‰´æƒæœ€ç¨³
        HF_ENDPOINT: https://huggingface.co
        # å¼ºåˆ¶ CPU æ¨ç†æ¨¡å¼ï¼Œé˜²æ­¢äº‘ç«¯æ‰¾ä¸åˆ° GPU æŠ¥é”™
        CUDA_VISIBLE_DEVICES: ""
      run: |
        # æ‰§è¡Œç‚¹ç«æµ‹è¯•
        # å¢åŠ äº† -v (è¯¦ç»†) å’Œ -s (æ˜¾ç¤ºè¾“å‡º)ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨ Actions æ—¥å¿—é‡Œçœ‹æ¨¡å‹ä¸‹è½½è¿›åº¦
        pytest -v -s tests/test_victory_lap.py