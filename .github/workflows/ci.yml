name: ğŸŒŠ FlexAligner CI

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .[test]
        # è¡¥å…¨ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®å’ŒéŸ³é¢‘å¤„ç†æ‰€éœ€çš„åº“
        pip install numpy scipy soundfile

    - name: Generate Mock Assets for CI
      run: |
        # åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„ç›®å½•ç»“æ„
        mkdir -p assets/examples
        # ç¼–å†™å¹¶è¿è¡Œä¸€ä¸ªæç®€è„šæœ¬ç”Ÿæˆ 1 ç§’çš„æ¨¡æ‹ŸéŸ³é¢‘ (16kHz, Mono)
        python -c "import numpy as np; from scipy.io import wavfile; data=np.zeros(16000, dtype=np.int16); wavfile.write('assets/examples/SP01_001.wav', 16000, data)"
        # ç”Ÿæˆå¯¹åº”çš„æ–‡æœ¬æ–‡ä»¶
        echo "æµ‹è¯•éŸ³é¢‘å†…å®¹" > assets/examples/SP01_001.txt
        echo "âœ… Mock assets generated successfully."

    - name: Run Pytest
      env:
        # å¼ºåˆ¶ç¯å¢ƒå˜é‡ï¼Œè®©ä»£ç åœ¨å›½å†…/å›½å¤–ç¯å¢ƒéƒ½èƒ½è‡ªé€‚åº”ï¼ˆGitHub Actions ç¯å¢ƒèµ°åŸç«™é€šå¸¸æ²¡é—®é¢˜ï¼‰
        # å¦‚æœä½ æƒ³è®© CI è·‘å¾—æ›´å¿«ï¼Œå¯ä»¥è¯•ç€æŒ‡å‘é•œåƒï¼Œä½†é€šå¸¸æ²¡å¿…è¦
        HF_ENDPOINT: https://huggingface.co
      run: |
        # å¯åŠ¨èƒœåˆ©æµ‹è¯•
        # å¦‚æœå†…å­˜çˆ†äº† (OOM)ï¼Œè¯·å°†æ­¤å‘½ä»¤æ”¹ä¸º: pytest tests/test_victory_lap.py -v --maxfail=1
        pytest tests/test_victory_lap.py